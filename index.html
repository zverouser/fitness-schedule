<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- Подключаем Telegram SDK (обязательно) -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Ваш код от 1С с расписанием -->
    <script src="https://reservi.ru/widget-fit1c.v2/js/config.js" data-fit-salon-id="faaa38c4-30d3-4d6d-ac61-08acc927e27a"></script>
    
    <style>
        /* Адаптация под тему Telegram */
        body {
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        
        /* Контейнер для расписания */
        .schedule-container {
            padding: 16px;
            min-height: 100vh;
        }
        
        /* Индикатор загрузки */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
            padding: 20px;
            color: var(--tg-theme-hint-color, #999999);
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            margin-bottom: 16px;
            border: 3px solid var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-top: 3px solid var(--tg-theme-button-color, #40a7e3);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Стили для темной темы (если понадобятся дополнительные настройки) */
        body.dark-theme {
            /* Дополнительные стили для темной темы можно добавить здесь */
        }
        
        /* Стили для самого расписания (виджет 1С) */
        [data-fit1c-calendar] {
            width: 100%;
            max-width: 100%;
            overflow-x: auto;
        }
        
        /* Адаптация элементов виджета под тему Telegram */
        [data-fit1c-calendar] button,
        [data-fit1c-calendar] .button {
            background-color: var(--tg-theme-button-color, #40a7e3) !important;
            color: var(--tg-theme-button-text-color, #ffffff) !important;
            border-radius: 8px !important;
            border: none !important;
        }
        
        [data-fit1c-calendar] a {
            color: var(--tg-theme-link-color, #40a7e3) !important;
        }
        
        /* Кнопка закрытия (если нужно закрыть приложение) */
        .close-btn {
            position: fixed;
            top: 16px;
            right: 16px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border: none;
            color: var(--tg-theme-text-color, #000000);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <!-- Индикатор загрузки (показываем пока грузится расписание) -->
    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <div>Загрузка расписания...</div>
    </div>
    
    <!-- Контейнер с расписанием (изначально скрыт) -->
    <div id="schedule-container" style="display: none;">
        <!-- Здесь будет ваше расписание -->
        <div data-fit1c-calendar>
            Расписание работает на <a href="https://www.fitness1c.ru">1С:Фитнес клуб</a>
        </div>
    </div>

    <script>
        // Получаем объект Telegram WebApp
        const WebApp = window.Telegram.WebApp;
        
        // Сообщаем Telegram, что приложение готово (убирает лоадер)
        WebApp.ready();
        
        // Расширяем на весь экран
        WebApp.expand();
        
        // === НОВЫЙ КОД: Поддержка тем Telegram ===
        // Если тема темная - добавляем класс к body
        if (WebApp.colorScheme === 'dark') {
            document.body.classList.add('dark-theme');
        }
        
        // Следим за сменой темы и перезагружаем страницу для применения новой темы к виджету
        WebApp.onEvent('themeChanged', function() {
            location.reload();
        });
        // === КОНЕЦ НОВОГО КОДА ===
        
        // Настраиваем основную кнопку (опционально - для закрытия)
        WebApp.MainButton.setText('Закрыть')
            .onClick(function() {
                WebApp.close();
            })
            .hide(); // Прячем, пока не нужно
        
        // Функция для проверки загрузки расписания
        function checkScheduleLoaded() {
            // Проверяем каждые 500мс, загрузилось ли расписание
            const checkInterval = setInterval(function() {
                // Ищем любой контент внутри виджета
                const widgetContent = document.querySelector('[data-fit1c-calendar]')?.children.length;
                
                // Если внутри виджета появились элементы (расписание загрузилось)
                if (widgetContent > 1) {
                    clearInterval(checkInterval);
                    
                    // Прячем индикатор загрузки
                    document.getElementById('loading').style.display = 'none';
                    
                    // Показываем контейнер с расписанием
                    document.getElementById('schedule-container').style.display = 'block';
                    
                    console.log('Расписание успешно загружено');
                    
                    // Небольшая задержка для плавности
                    setTimeout(() => {
                        // Сообщаем Telegram, что контент загружен и можно скрыть лоадер
                        WebApp.isFullscreen = true;
                    }, 100);
                }
            }, 500);
            
            // Таймаут на случай, если расписание не загрузилось
            setTimeout(function() {
                clearInterval(checkInterval);
                
                // Если расписание так и не загрузилось
                if (document.getElementById('schedule-container').style.display !== 'block') {
                    document.getElementById('loading').innerHTML = `
                        <div style="color: var(--tg-theme-destructive-text-color, #ff3b30);">
                            Не удалось загрузить расписание<br>
                            <small>Проверьте подключение к интернету</small>
                        </div>
                    `;
                    
                    // Показываем кнопку закрытия
                    WebApp.MainButton.show();
                }
            }, 10000); // 10 секунд таймаут
        }
        
        // Обработка ошибок скрипта расписания
        window.addEventListener('error', function(e) {
            console.error('Ошибка загрузки:', e.message);
            
            // Если ошибка связана с виджетом
            if (e.target.src && e.target.src.includes('reservi.ru')) {
                document.getElementById('loading').innerHTML = `
                    <div style="color: var(--tg-theme-destructive-text-color, #ff3b30);">
                        Ошибка загрузки расписания<br>
                        <small>Пожалуйста, попробуйте позже</small>
                    </div>
                `;
                WebApp.MainButton.show();
            }
        });
        
        // Запускаем проверку загрузки
        checkScheduleLoaded();
        
        // Обработка изменения темы Telegram
        WebApp.onEvent('themeChanged', function() {
            // Тема автоматически применяется через CSS переменные
            console.log('Тема изменена');
        });
        
        // Обработка сворачивания/разворачивания
        WebApp.onEvent('viewportChanged', function() {
            console.log('Размер окна изменен');
        });
        
        // Если пользователь пытается закрыть через системную кнопку "Назад"
        WebApp.onEvent('backButtonClicked', function() {
            WebApp.close();
        });
        
    </script>
</body>
</html>
